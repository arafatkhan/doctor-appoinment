{% extends 'appointments/base.html' %}

{% block title %}Doctor Dashboard{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h3><i class="fas fa-user-md"></i> Dr. {{ doctor.name }}</h3>
                    <p class="mb-0">{{ doctor.specialization }}</p>
                    <small>{{ doctor.email }} | {{ doctor.phone }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-primary">{{ total_appointments }}</h2>
                    <p class="mb-0">Total Appointments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-info">{{ upcoming_appointments.count }}</h2>
                    <p class="mb-0">Upcoming</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-success">{{ completed_appointments }}</h2>
                    <p class="mb-0">Completed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h2 class="text-warning">{{ today_appointments }}</h2>
                    <p class="mb-0">Today's Appointments</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hourly Appointment Limit Status -->
    {% if hourly_stats %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-clock"></i> Today's Hourly Appointment Status (Max: 20 per hour)</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for stat in hourly_stats %}
                <div class="col-md-4 col-sm-6 mb-3">
                    <div class="card border-{% if stat.is_full %}danger{% elif stat.is_almost_full %}warning{% else %}success{% endif %}">
                        <div class="card-body text-center p-3">
                            <h6 class="card-title mb-1">
                                <i class="fas fa-clock"></i> {{ stat.hour }}
                            </h6>
                            <h4 class="mb-1 text-{% if stat.is_full %}danger{% elif stat.is_almost_full %}warning{% else %}success{% endif %}">
                                {{ stat.count }}/20
                            </h4>
                            <small class="text-{% if stat.is_full %}danger{% elif stat.is_almost_full %}warning{% else %}success{% endif %}">
                                {{ stat.status }}
                                {% if stat.is_full %}
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% elif stat.is_almost_full %}
                                    <i class="fas fa-clock"></i>
                                {% else %}
                                    <i class="fas fa-check-circle"></i>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i> 
                <strong>Note:</strong> প্রতি ঘণ্টায় সর্বোচ্চ 20টি appointment নেওয়া যাবে। 
                20টি পূর্ণ হলে নতুন booking এ automatic warning দেখাবে।
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Today's Appointments -->
    {% if today_appointments > 0 %}
    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Today's Appointments</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Patient Name</th>
                            <th>Contact</th>
                            <th>Reason</th>
                            <th>Payment</th>
                            <th>Zoom Link</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in todays_list %}
                        <tr>
                            <td><strong>{{ appointment.appointment_time }}</strong></td>
                            <td>
                                <i class="fas fa-user"></i> {{ appointment.patient.user.get_full_name }}
                                {% if appointment.patient.age %}
                                    <br><small class="text-muted">Age: {{ appointment.patient.age }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    <i class="fas fa-phone"></i> {{ appointment.patient.phone }}<br>
                                    <i class="fas fa-envelope"></i> {{ appointment.patient.user.email }}
                                </small>
                            </td>
                            <td>{{ appointment.reason|truncatewords:5 }}</td>
                            <td>
                                <span class="badge bg-{{ appointment.payment_status }}">
                                    {{ appointment.get_payment_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if appointment.zoom_join_url %}
                                    <a href="{{ appointment.zoom_start_url }}" target="_blank" class="btn btn-sm btn-success">
                                        <i class="fas fa-video"></i> Start Meeting
                                    </a>
                                {% else %}
                                    <span class="text-muted">Not Generated</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'doctor_appointment_detail' appointment.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Upcoming Appointments -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Upcoming Appointments</h5>
        </div>
        <div class="card-body">
            {% if upcoming_appointments %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Patient Name</th>
                            <th>Contact</th>
                            <th>Medical Info</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in upcoming_appointments %}
                        <tr>
                            <td>
                                <strong>{{ appointment.appointment_date }}</strong><br>
                                <small>{{ appointment.appointment_time }}</small>
                            </td>
                            <td>
                                <strong>{{ appointment.patient.user.get_full_name }}</strong>
                                {% if appointment.patient.gender %}
                                    <br><small class="text-muted">{{ appointment.patient.gender }}</small>
                                {% endif %}
                                {% if appointment.patient.age %}
                                    <small class="text-muted">/ {{ appointment.patient.age }} years</small>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    <i class="fas fa-phone"></i> {{ appointment.patient.phone }}<br>
                                    <i class="fas fa-envelope"></i> {{ appointment.patient.user.email }}
                                </small>
                            </td>
                            <td>
                                <small>
                                    {% if appointment.patient.blood_group %}
                                        <span class="badge bg-danger">{{ appointment.patient.blood_group }}</span>
                                    {% endif %}
                                    {% if appointment.patient.allergies %}
                                        <br><span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Allergies</span>
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                {{ appointment.reason|truncatewords:10 }}
                                {% if appointment.symptoms %}
                                    <br><small class="text-muted">{{ appointment.symptoms|truncatewords:5 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ appointment.status }}">
                                    {{ appointment.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ appointment.payment_status }}">
                                    {{ appointment.get_payment_status_display }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'doctor_appointment_detail' appointment.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Details
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">No upcoming appointments</p>
            {% endif %}
        </div>
    </div>

    <!-- Past Appointments -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-history"></i> Past Appointments (Last 10)</h5>
        </div>
        <div class="card-body">
            {% if past_appointments %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Patient Name</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in past_appointments %}
                        <tr>
                            <td>{{ appointment.appointment_date }}</td>
                            <td>{{ appointment.patient.user.get_full_name }}</td>
                            <td>{{ appointment.reason|truncatewords:5 }}</td>
                            <td>
                                <span class="badge bg-{{ appointment.status }}">
                                    {{ appointment.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ appointment.payment_status }}">
                                    {{ appointment.get_payment_status_display }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'doctor_appointment_detail' appointment.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">No past appointments</p>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-tasks"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <a href="{% url 'doctor_schedule' %}" class="btn btn-outline-primary btn-lg btn-block w-100">
                        <i class="fas fa-calendar-plus"></i><br>
                        Manage Schedule
                    </a>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="{% url 'doctor_patients_list' %}" class="btn btn-outline-info btn-lg btn-block w-100">
                        <i class="fas fa-users"></i><br>
                        All Patients
                    </a>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="{% url 'doctor_profile' %}" class="btn btn-outline-success btn-lg btn-block w-100">
                        <i class="fas fa-user-edit"></i><br>
                        Edit Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.badge.bg-paid { background-color: #28a745 !important; }
.badge.bg-pending { background-color: #ffc107 !important; color: #000; }
.badge.bg-failed { background-color: #dc3545 !important; }
.badge.bg-confirmed { background-color: #17a2b8 !important; }
.badge.bg-completed { background-color: #28a745 !important; }
.badge.bg-cancelled { background-color: #6c757d !important; }
.status-badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; }
</style>
{% endblock %}
