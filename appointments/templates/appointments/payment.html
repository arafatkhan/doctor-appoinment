{% extends 'appointments/base.html' %}

{% block title %}Payment{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="fas fa-credit-card"></i> Payment</h4>
                </div>
                <div class="card-body">
                    <h5 class="mb-4">Appointment Details</h5>
                    
                    <div class="mb-3">
                        <strong>Doctor:</strong> Dr. {{ appointment.doctor.name }}<br>
                        <strong>Date:</strong> {{ appointment.appointment_date }}<br>
                        <strong>Time:</strong> {{ appointment.appointment_time }}<br>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Consultation Fee:</span>
                        <strong>৳{{ appointment.amount }}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <h5>Total Amount:</h5>
                        <h5 class="text-success">৳{{ appointment.amount }}</h5>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-flask"></i> 
                        <strong>TEST MODE:</strong> This is running in test mode. Payment will be auto-completed without real bKash integration.
                        <br><small>When you get bKash credentials, the system will use real payment gateway.</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Click "Pay Now" to simulate payment. After successful payment, you will receive your Zoom meeting link.
                    </div>
                    
                    <button id="payWithBkash" class="btn btn-warning btn-lg w-100">
                        <i class="fas fa-mobile-alt"></i> Pay Now (Test Mode)
                    </button>
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'appointment_detail' appointment.id %}" class="btn btn-link">Back to Appointment</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

$(document).ready(function() {
    console.log('Payment page loaded, CSRF token:', csrftoken);
    
    $('#payWithBkash').click(function(e) {
        e.preventDefault();
        console.log('Pay button clicked');
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');
        
        $.ajax({
            url: '{% url "process_bkash_payment" appointment.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                console.log('Payment response:', response);
                if (response.success && response.bkash_url) {
                    // Redirect to bKash payment page
                    window.location.href = response.bkash_url;
                } else {
                    alert('Payment initiation failed: ' + response.message);
                    $('#payWithBkash').prop('disabled', false).html('<i class="fas fa-mobile-alt"></i> Pay Now (Test Mode)');
                }
            },
            error: function(xhr, status, error) {
                console.error('Payment error:', xhr.responseText);
                alert('An error occurred: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                $('#payWithBkash').prop('disabled', false).html('<i class="fas fa-mobile-alt"></i> Pay Now (Test Mode)');
            }
        });
    });
});
</script>
{% endblock %}
