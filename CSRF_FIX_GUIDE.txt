╔══════════════════════════════════════════════════════════════════════╗
║              CSRF ERROR FIX - TROUBLESHOOTING GUIDE                  ║
╚══════════════════════════════════════════════════════════════════════╝

✅ CSRF Error ঠিক করা হয়েছে!

═══════════════════════════════════════════════════════════════════════
🔧 যা যা FIX করা হয়েছে:
═══════════════════════════════════════════════════════════════════════

1. Payment.html - AJAX Request Fix
──────────────────────────────────────────────────────────────────────
❌ আগে: 'X-CSRFToken': '{{ csrf_token }}'
✅ এখন: Cookie থেকে CSRF token নেওয়া হচ্ছে

JavaScript function যোগ করা হয়েছে:
- getCookie() function
- csrftoken variable
- Proper header setup


2. process_bkash_payment View - Security Enhancement
──────────────────────────────────────────────────────────────────────
✅ @login_required decorator যোগ করা হয়েছে
✅ POST method check যোগ করা হয়েছে
✅ CSRF protection active


3. All Templates Verified
──────────────────────────────────────────────────────────────────────
✅ login.html - csrf_token আছে
✅ register.html - csrf_token আছে
✅ book_appointment.html - csrf_token আছে
✅ profile.html - csrf_token আছে
✅ cancel_appointment.html - csrf_token আছে
✅ doctor_appointment_detail.html - csrf_token আছে (2 forms)
✅ payment.html - AJAX এ proper CSRF handling


═══════════════════════════════════════════════════════════════════════
🔄 এখন কি করবেন:
═══════════════════════════════════════════════════════════════════════

1. Browser Refresh করুন (Ctrl+F5 বা Cmd+Shift+R)
   → Cache clear হয়ে যাবে

2. যদি এখনও error হয়:
   → Browser completely close করুন
   → Browser আবার open করুন
   → Login করুন
   → Payment page-এ যান

3. Browser Console Check করুন:
   → F12 press করুন
   → Console tab-এ যান
   → কোনো JavaScript error আছে কিনা দেখুন


═══════════════════════════════════════════════════════════════════════
🧪 PAYMENT TESTING STEPS:
═══════════════════════════════════════════════════════════════════════

Step 1: Login as Patient
──────────────────────────────────────────────────────────────────────
http://localhost:8000/login
Username: (any patient username)
Password: (patient password)


Step 2: Book Appointment
──────────────────────────────────────────────────────────────────────
1. Go to: http://localhost:8000/appointments/book/
2. Select doctor
3. Select date and time
4. Add reason and symptoms
5. Click "Book Appointment"


Step 3: Make Payment
──────────────────────────────────────────────────────────────────────
1. You'll be redirected to appointment detail page
2. Click "Make Payment" button
3. You'll see payment page with amount
4. Click "Pay Now (Test Mode)" button
5. ✅ Should redirect to success page automatically


Step 4: Verify
──────────────────────────────────────────────────────────────────────
1. Check appointment status → should be "Confirmed"
2. Check payment status → should be "Paid"
3. Zoom meeting link → should be available (if API works)


═══════════════════════════════════════════════════════════════════════
🔍 DEBUG CHECKLIST:
═══════════════════════════════════════════════════════════════════════

✅ Server running? → http://localhost:8000
✅ Logged in as patient?
✅ Browser cookies enabled?
✅ JavaScript enabled in browser?
✅ No browser extensions blocking cookies?
✅ Page fully loaded before clicking button?
✅ Browser console showing any errors?


═══════════════════════════════════════════════════════════════════════
💡 COMMON ISSUES & SOLUTIONS:
═══════════════════════════════════════════════════════════════════════

Issue 1: "CSRF token missing or incorrect"
──────────────────────────────────────────────────────────────────────
Solution:
- Clear browser cache (Ctrl+Shift+Delete)
- Close all browser tabs
- Restart browser
- Login again


Issue 2: Payment button not working
──────────────────────────────────────────────────────────────────────
Solution:
- Check browser console (F12)
- Make sure jQuery is loaded
- Refresh page (Ctrl+F5)


Issue 3: "403 Forbidden"
──────────────────────────────────────────────────────────────────────
Solution:
- Make sure you're logged in
- Check if cookies are enabled
- Try in incognito/private mode


Issue 4: Redirect not happening
──────────────────────────────────────────────────────────────────────
Solution:
- Check JavaScript console for errors
- Make sure popup blockers are off
- Try different browser


═══════════════════════════════════════════════════════════════════════
🛠️ TECHNICAL DETAILS:
═══════════════════════════════════════════════════════════════════════

CSRF Token Flow:
──────────────────────────────────────────────────────────────────────
1. Django generates CSRF token on page load
2. Token stored in cookie: csrftoken
3. JavaScript reads token from cookie
4. Token sent in AJAX request header: X-CSRFToken
5. Django validates token
6. Request processed


Files Modified:
──────────────────────────────────────────────────────────────────────
✓ appointments/templates/appointments/payment.html
  - Added getCookie() function
  - Fixed CSRF token in AJAX header

✓ appointments/views.py
  - Added @login_required to process_bkash_payment
  - Added POST method check


═══════════════════════════════════════════════════════════════════════
📝 ALTERNATIVE METHODS (if still having issues):
═══════════════════════════════════════════════════════════════════════

Method 1: Use Hidden Input in Form
──────────────────────────────────────────────────────────────────────
Instead of AJAX, use regular form submission:

<form method="post" action="{% url 'process_bkash_payment' appointment.id %}">
    {% csrf_token %}
    <button type="submit">Pay Now</button>
</form>


Method 2: Use Django's ensure_csrf_cookie
──────────────────────────────────────────────────────────────────────
Add to views.py:
from django.views.decorators.csrf import ensure_csrf_cookie

@ensure_csrf_cookie
def payment_page(request, appointment_id):
    ...


Method 3: Check Django Settings
──────────────────────────────────────────────────────────────────────
In settings.py, verify:
- CSRF_COOKIE_HTTPONLY = False (for JavaScript access)
- CSRF_USE_SESSIONS = False
- CSRF_COOKIE_SECURE = False (in development)


═══════════════════════════════════════════════════════════════════════
✅ CURRENT STATUS:
═══════════════════════════════════════════════════════════════════════

Server: ✅ Running at http://localhost:8000
CSRF Fix: ✅ Applied
Templates: ✅ All have csrf_token
Views: ✅ Login required added
JavaScript: ✅ Cookie reading function added


═══════════════════════════════════════════════════════════════════════
🚀 NEXT STEPS:
═══════════════════════════════════════════════════════════════════════

1. Refresh browser (Ctrl+F5)
2. Clear browser cache if needed
3. Login as patient
4. Book appointment
5. Try payment again
6. ✅ Should work now!


যদি এখনও error হয় তাহলে:
- Browser console screenshot পাঠান
- Error message পুরোটা copy করুন
- কোন page-এ error হচ্ছে সেটা বলুন

═══════════════════════════════════════════════════════════════════════
